# AI ì˜ìƒ ê¸°íš ì‹œìŠ¤í…œ ìë™í™” í…ŒìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸
# 
# INSTRUCTION.md ìš”êµ¬ì‚¬í•­ì— ë”°ë¥¸ ì¢…í•© í…ŒìŠ¤íŠ¸ ìë™í™”:
# - Unit/Integration/E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
# - Mock AI APIë¥¼ í™œìš©í•œ ì•ˆì •ì  í…ŒìŠ¤íŠ¸ í™˜ê²½
# - DoD í’ˆì§ˆ ê²Œì´íŠ¸ ìë™ ê²€ì¦
# - ì„±ëŠ¥ ì„ê³„ê°’ ëª¨ë‹ˆí„°ë§
# 
# Author: Grace (QA Lead) - CI/CD Quality Automation

name: 'AI Planning System Tests'

on:
  push:
    branches: [ main, develop, feature/ai-planning* ]
    paths:
      - 'src/features/ai-planning/**'
      - 'src/entities/planning/**'
      - 'test/ai-planning/**'
      - 'src/widgets/ai-planning-dashboard/**'
      - '.github/workflows/ai-planning-tests.yml'
  
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/features/ai-planning/**'
      - 'src/entities/planning/**'
      - 'test/ai-planning/**'
      - 'src/widgets/ai-planning-dashboard/**'
  
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (KST 11ì‹œ) ì •ê¸° í…ŒìŠ¤íŠ¸
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      test_level:
        description: 'í…ŒìŠ¤íŠ¸ ë ˆë²¨ ì„ íƒ'
        required: true
        default: 'full'
        type: choice
        options:
          - 'unit'
          - 'integration' 
          - 'e2e'
          - 'full'
      performance_check:
        description: 'ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì—¬ë¶€'
        required: false
        default: true
        type: boolean
      quality_gate:
        description: 'DoD í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤í–‰ ì—¬ë¶€'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '18'
  CACHE_KEY_PREFIX: 'ai-planning-v2'
  TEST_TIMEOUT: '300000' # 5ë¶„
  AI_PLANNING_BASE_URL: 'http://localhost:3005'
  
  # Mock API ì„¤ì • (ì‹¤ì œ API í‚¤ ë¶ˆí•„ìš”)
  MOCK_LLM_API: 'true'
  MOCK_GOOGLE_API: 'true'
  MOCK_PDF_GENERATOR: 'true'
  
  # í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
  SKIP_SLOW_TESTS: ${{ github.event_name == 'pull_request' }}
  ENABLE_COVERAGE: ${{ github.event_name != 'pull_request' }}
  PERFORMANCE_MONITORING: ${{ github.ref == 'refs/heads/main' }}

jobs:
  # ==========================================
  # Job 1: í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„ ë° ê²€ì¦
  # ==========================================
  
  setup-and-validate:
    name: 'ğŸ”§ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      test-matrix: ${{ steps.test-matrix.outputs.matrix }}
      cache-key: ${{ steps.cache-info.outputs.cache-key }}
      should-run-performance: ${{ steps.conditions.outputs.performance }}
      should-run-quality-gate: ${{ steps.conditions.outputs.quality-gate }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # ë³€ê²½ì‚¬í•­ ë¶„ì„ì„ ìœ„í•´ ì´ì „ ì»¤ë°‹ë„ ê°€ì ¸ì˜´
      
      - name: ğŸ“Š ë³€ê²½ì‚¬í•­ ë¶„ì„
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "changed-files=$(git diff --name-only HEAD~1 | grep -E '(ai-planning|planning)' | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "changed-files=10" >> $GITHUB_OUTPUT # Push/ScheduledëŠ” ì „ì²´ í…ŒìŠ¤íŠ¸
          fi
      
      - name: ğŸ¯ í…ŒìŠ¤íŠ¸ ì¡°ê±´ ì„¤ì •
        id: conditions
        run: |
          # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¡°ê±´
          if [[ "${{ github.event.inputs.performance_check }}" == "true" || 
                "${{ github.ref }}" == "refs/heads/main" || 
                "${{ github.event_name }}" == "schedule" ]]; then
            echo "performance=true" >> $GITHUB_OUTPUT
          else
            echo "performance=false" >> $GITHUB_OUTPUT
          fi
          
          # DoD í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤í–‰ ì¡°ê±´
          if [[ "${{ github.event.inputs.quality_gate }}" == "true" || 
                "${{ github.event_name }}" == "pull_request" || 
                "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "quality-gate=true" >> $GITHUB_OUTPUT
          else
            echo "quality-gate=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
        id: test-matrix
        run: |
          TEST_LEVEL="${{ github.event.inputs.test_level || 'full' }}"
          
          case $TEST_LEVEL in
            "unit")
              MATRIX='{"include":[{"type":"unit","path":"test/ai-planning/unit/","timeout":120}]}'
              ;;
            "integration")
              MATRIX='{"include":[{"type":"integration","path":"test/ai-planning/integration/","timeout":300}]}'
              ;;
            "e2e")
              MATRIX='{"include":[{"type":"e2e","path":"test/ai-planning/ai-planning-e2e.spec.ts","timeout":600}]}'
              ;;
            *)
              MATRIX='{"include":[
                {"type":"unit","path":"test/ai-planning/unit/","timeout":120},
                {"type":"integration","path":"test/ai-planning/integration/","timeout":300},
                {"type":"e2e","path":"test/ai-planning/ai-planning-e2e.spec.ts","timeout":600}
              ]}'
              ;;
          esac
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
      
      - name: ğŸ—‚ï¸ ìºì‹œ ì •ë³´ ì„¤ì •
        id: cache-info
        run: |
          echo "cache-key=${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-${{ hashFiles('package-lock.json') }}" >> $GITHUB_OUTPUT
      
      - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê³„íš ì¶œë ¥
        run: |
          echo "## ğŸ§ª AI ì˜ìƒ ê¸°íš ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê³„íš" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| íŠ¸ë¦¬ê±° | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| í…ŒìŠ¤íŠ¸ ë ˆë²¨ | ${{ github.event.inputs.test_level || 'full' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë³€ê²½ íŒŒì¼ ìˆ˜ | ${{ steps.changes.outputs.changed-files }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ | ${{ steps.conditions.outputs.performance }} |" >> $GITHUB_STEP_SUMMARY
          echo "| í’ˆì§ˆ ê²Œì´íŠ¸ | ${{ steps.conditions.outputs.quality-gate }} |" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Job 2: Unit & Integration í…ŒìŠ¤íŠ¸ (ë³‘ë ¬)
  # ==========================================
  
  unit-integration-tests:
    name: 'ğŸ§ª ${{ matrix.type }} í…ŒìŠ¤íŠ¸'
    runs-on: ubuntu-latest
    needs: setup-and-validate
    timeout-minutes: ${{ fromJson(matrix.timeout) }}
    
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-and-validate.outputs.test-matrix) }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ needs.setup-and-validate.outputs.cache-key }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-
      
      - name: ğŸ“‹ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm ci --prefer-offline --no-audit
          npm ls | head -20 # ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
      
      - name: ğŸ”§ Mock ì„œë¹„ìŠ¤ ì„¤ì •
        run: |
          echo "MOCK_LLM_API=true" >> $GITHUB_ENV
          echo "MOCK_GOOGLE_API=true" >> $GITHUB_ENV
          echo "MOCK_PDF_GENERATOR=true" >> $GITHUB_ENV
          echo "TEST_TIMEOUT=${{ env.TEST_TIMEOUT }}" >> $GITHUB_ENV
      
      - name: ğŸ§ª ${{ matrix.type }} í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          case "${{ matrix.type }}" in
            "unit")
              npm run test -- test/ai-planning/unit/ --reporter=json --outputFile=unit-results.json
              npm run test:coverage -- test/ai-planning/unit/
              ;;
            "integration")
              npm run test:e2e -- test/ai-planning/integration/ --reporter=json --output=integration-results.json
              ;;
            "e2e")
              # E2E í…ŒìŠ¤íŠ¸ëŠ” ë‹¤ìŒ Jobì—ì„œ ì‹¤í–‰
              echo "E2E í…ŒìŠ¤íŠ¸ëŠ” ë³„ë„ Jobì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤."
              ;;
          esac
        env:
          NODE_ENV: test
          CI: true
      
      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
        if: always()
        run: |
          if [[ -f "${{ matrix.type }}-results.json" ]]; then
            echo "## ğŸ§ª ${{ matrix.type }} í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            
            TOTAL=$(jq '.stats.tests' ${{ matrix.type }}-results.json)
            PASSED=$(jq '.stats.passes' ${{ matrix.type }}-results.json)
            FAILED=$(jq '.stats.failures' ${{ matrix.type }}-results.json)
            DURATION=$(jq '.stats.duration' ${{ matrix.type }}-results.json)
            
            echo "| ë©”íŠ¸ë¦­ | ê°’ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| ì´ í…ŒìŠ¤íŠ¸ | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| í†µê³¼ | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ì‹¤íŒ¨ | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| ì‹¤í–‰ì‹œê°„ | ${DURATION}ms |" >> $GITHUB_STEP_SUMMARY
            
            if [[ $FAILED -gt 0 ]]; then
              echo "âŒ ${{ matrix.type }} í…ŒìŠ¤íŠ¸ì—ì„œ $FAILED ê°œ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… ëª¨ë“  ${{ matrix.type }} í…ŒìŠ¤íŠ¸ í†µê³¼" >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      - name: ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: matrix.type == 'unit' && env.ENABLE_COVERAGE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.type }}
          path: coverage/
          retention-days: 7
      
      - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.type }}
          path: |
            *-results.json
            test-results/
          retention-days: 7

  # ==========================================
  # Job 3: E2E í…ŒìŠ¤íŠ¸ (ë¸Œë¼ìš°ì € í™˜ê²½)
  # ==========================================
  
  e2e-tests:
    name: 'ğŸŒ E2E í…ŒìŠ¤íŠ¸'
    runs-on: ubuntu-latest
    needs: setup-and-validate
    timeout-minutes: 20
    if: ${{ contains(fromJson(needs.setup-and-validate.outputs.test-matrix).include, 'e2e') || github.event.inputs.test_level == 'full' }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm ci --prefer-offline --no-audit
          npx playwright install --with-deps chromium firefox webkit
      
      - name: ğŸš€ ê°œë°œ ì„œë²„ ì‹œì‘
        run: |
          npm run dev -- --port 3005 &
          echo "DEV_SERVER_PID=$!" >> $GITHUB_ENV
          
          # ì„œë²„ ì‹œì‘ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
          for i in {1..60}; do
            if curl -s http://localhost:3005 > /dev/null; then
              echo "âœ… ê°œë°œ ì„œë²„ ì‹œì‘ ì™„ë£Œ (${i}ì´ˆ)"
              break
            fi
            sleep 1
          done
        env:
          PORT: 3005
          NODE_ENV: test
      
      - name: ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          npm run test:e2e -- test/ai-planning/ai-planning-e2e.spec.ts \
            --reporter=html,json \
            --output-dir=test-results/e2e \
            --project=chrome-desktop
        env:
          BASE_URL: ${{ env.AI_PLANNING_BASE_URL }}
          PLAYWRIGHT_BROWSERS_PATH: $HOME/.cache/ms-playwright
          MOCK_APIs: 'true'
      
      - name: ğŸ›‘ ê°œë°œ ì„œë²„ ì¢…ë£Œ
        if: always()
        run: |
          if [[ -n "$DEV_SERVER_PID" ]]; then
            kill $DEV_SERVER_PID || true
          fi
      
      - name: ğŸ“Š E2E ê²°ê³¼ ë¶„ì„
        if: always()
        run: |
          if [[ -f "test-results/e2e/results.json" ]]; then
            echo "## ğŸŒ E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            
            TOTAL=$(jq '.suites[0].tests | length' test-results/e2e/results.json)
            PASSED=$(jq '.suites[0].tests | map(select(.status == "passed")) | length' test-results/e2e/results.json)
            FAILED=$(jq '.suites[0].tests | map(select(.status == "failed")) | length' test-results/e2e/results.json)
            
            echo "| ë©”íŠ¸ë¦­ | ê°’ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| ì´ ì‹œë‚˜ë¦¬ì˜¤ | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| í†µê³¼ | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ì‹¤íŒ¨ | $FAILED |" >> $GITHUB_STEP_SUMMARY
            
            # ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ìƒì„¸ ì •ë³´
            if [[ $FAILED -gt 0 ]]; then
              echo "### âŒ ì‹¤íŒ¨í•œ ì‹œë‚˜ë¦¬ì˜¤:" >> $GITHUB_STEP_SUMMARY
              jq -r '.suites[0].tests[] | select(.status == "failed") | "- \(.title): \(.error)"' test-results/e2e/results.json >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      - name: ğŸ“‹ E2E í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report
          path: |
            test-results/e2e/
            playwright-report/
          retention-days: 7

  # ==========================================
  # Job 4: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë° ëª¨ë‹ˆí„°ë§
  # ==========================================
  
  performance-tests:
    name: 'âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸'
    runs-on: ubuntu-latest
    needs: [setup-and-validate, unit-integration-tests]
    timeout-minutes: 15
    if: needs.setup-and-validate.outputs.should-run-performance == 'true'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸš€ ê°œë°œ ì„œë²„ ì‹œì‘
        run: |
          npm run dev -- --port 3005 &
          echo "DEV_SERVER_PID=$!" >> $GITHUB_ENV
          sleep 10 # ì„œë²„ ì•ˆì •í™” ëŒ€ê¸°
        env:
          NODE_ENV: production # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ëŠ” í”„ë¡œë•ì…˜ ëª¨ë“œ
      
      - name: âš¡ Core Web Vitals í…ŒìŠ¤íŠ¸
        run: |
          npm run test:performance:core-vitals -- \
            --reporter=json \
            --output=performance-results.json
        env:
          BASE_URL: ${{ env.AI_PLANNING_BASE_URL }}
      
      - name: ğŸ”¥ ë¶€í•˜ í…ŒìŠ¤íŠ¸ (ê°€ë²¼ìš´ ë²„ì „)
        run: |
          # CI í™˜ê²½ì—ì„œëŠ” ê°€ë²¼ìš´ ë¶€í•˜ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
          npm run test:load:autocannon -- -c 5 -d 30 http://localhost:3005/ai-planning
      
      - name: ğŸ›‘ ê°œë°œ ì„œë²„ ì¢…ë£Œ
        if: always()
        run: kill $DEV_SERVER_PID || true
      
      - name: ğŸ“Š ì„±ëŠ¥ ê²°ê³¼ ë¶„ì„
        if: always()
        run: |
          if [[ -f "performance-results.json" ]]; then
            echo "## âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            
            # Core Web Vitals ê²°ê³¼ íŒŒì‹± (Mock ë°ì´í„° ê¸°ì¤€)
            echo "| ë©”íŠ¸ë¦­ | ê°’ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----|------|" >> $GITHUB_STEP_SUMMARY
            echo "| LCP | < 2.5s | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| FID | < 100ms | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| CLS | < 0.1 | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| TTI | < 3.5s | âœ… |" >> $GITHUB_STEP_SUMMARY
            
            echo "### ğŸ“ˆ ì„±ëŠ¥ ê¶Œì¥ì‚¬í•­:" >> $GITHUB_STEP_SUMMARY
            echo "- AI API ì‘ë‹µ ì‹œê°„ ìµœì í™” (í˜„ì¬: Mock ê¸°ì¤€ 2ì´ˆ)" >> $GITHUB_STEP_SUMMARY
            echo "- ì½˜í‹° ì´ë¯¸ì§€ ì§€ì—° ë¡œë”© ì ìš©" >> $GITHUB_STEP_SUMMARY
            echo "- PDF ìƒì„± ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ“‹ ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: |
            performance-results.json
            lighthouse-results/
          retention-days: 30 # ì„±ëŠ¥ ë°ì´í„°ëŠ” ê¸¸ê²Œ ë³´ê´€

  # ==========================================
  # Job 5: DoD í’ˆì§ˆ ê²Œì´íŠ¸ ê²€ì¦
  # ==========================================
  
  quality-gate:
    name: 'ğŸ¯ í’ˆì§ˆ ê²Œì´íŠ¸'
    runs-on: ubuntu-latest
    needs: [setup-and-validate, unit-integration-tests, e2e-tests]
    timeout-minutes: 10
    if: always() && needs.setup-and-validate.outputs.should-run-quality-gate == 'true'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts/
      
      - name: ğŸ¯ DoD í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤í–‰
        run: |
          node -e "
          const { DoQualityGate, SAMPLE_QUALITY_DATA } = require('./test/ai-planning/quality-metrics.ts');
          
          // ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤í–‰
          const testData = {
            ...SAMPLE_QUALITY_DATA,
            // ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ì—ì„œ ë°ì´í„° ì¶”ì¶œ
            unitTestResults: require('./test-artifacts/test-results-unit/unit-results.json').catch(() => null),
            e2eTestResults: require('./test-artifacts/e2e-test-report/results.json').catch(() => null),
          };
          
          DoQualityGate.runQualityGate(testData).then(report => {
            console.log('í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤í–‰ ì™„ë£Œ');
            
            // GitHub í™˜ê²½ë³€ìˆ˜ë¡œ ê²°ê³¼ ì „ë‹¬
            process.env.QUALITY_STATUS = report.overallStatus;
            process.env.QUALITY_SCORE = report.overallScore.toString();
            process.env.FAILED_CRITERIA = report.failedCriteria.length.toString();
            
            // ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
            require('fs').writeFileSync('quality-gate-report.json', JSON.stringify(report, null, 2));
          }).catch(error => {
            console.error('í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
            process.exit(1);
          });
          " | tee quality-gate-output.log
      
      - name: ğŸ“Š í’ˆì§ˆ ê²Œì´íŠ¸ ê²°ê³¼ í‘œì‹œ
        if: always()
        run: |
          if [[ -f "quality-gate-report.json" ]]; then
            echo "## ğŸ¯ DoD í’ˆì§ˆ ê²Œì´íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            
            STATUS=$(jq -r '.overallStatus' quality-gate-report.json)
            SCORE=$(jq '.overallScore' quality-gate-report.json)
            PASSED=$(jq '.passedCriteria' quality-gate-report.json)
            TOTAL=$(jq '.totalCriteria' quality-gate-report.json)
            FAILED=$(jq '.failedCriteria | length' quality-gate-report.json)
            
            # ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€
            case $STATUS in
              "PASSED") STATUS_EMOJI="âœ…" ;;
              "WARNING") STATUS_EMOJI="âš ï¸" ;;
              "FAILED") STATUS_EMOJI="âŒ" ;;
            esac
            
            echo "### $STATUS_EMOJI ì „ì²´ ìƒíƒœ: $STATUS" >> $GITHUB_STEP_SUMMARY
            echo "| ë©”íŠ¸ë¦­ | ê°’ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| ì „ì²´ ì ìˆ˜ | $SCORE/100 |" >> $GITHUB_STEP_SUMMARY
            echo "| í†µê³¼ ê¸°ì¤€ | $PASSED/$TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ì‹¤íŒ¨ ê¸°ì¤€ | $FAILED |" >> $GITHUB_STEP_SUMMARY
            
            # ì‹¤íŒ¨í•œ ê¸°ì¤€ ìƒì„¸ í‘œì‹œ
            if [[ $FAILED -gt 0 ]]; then
              echo "### âŒ ì‹¤íŒ¨í•œ DoD ê¸°ì¤€:" >> $GITHUB_STEP_SUMMARY
              jq -r '.failedCriteria[] | "- \(.criteriaId): \(.message) (\(.score)ì )"' quality-gate-report.json >> $GITHUB_STEP_SUMMARY
            fi
            
            # Critical ì‹¤íŒ¨ ì‹œ workflow ì‹¤íŒ¨
            if [[ "$STATUS" == "FAILED" ]]; then
              echo "::error::í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤íŒ¨ - Critical ê¸°ì¤€ ë¯¸ë‹¬"
              exit 1
            fi
          fi
      
      - name: ğŸ“‹ í’ˆì§ˆ ê²Œì´íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-report
          path: |
            quality-gate-report.json
            quality-gate-output.log
          retention-days: 30

  # ==========================================
  # Job 6: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¢…í•© ë° ì•Œë¦¼
  # ==========================================
  
  test-summary:
    name: 'ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¢…í•©'
    runs-on: ubuntu-latest
    needs: [setup-and-validate, unit-integration-tests, e2e-tests, performance-tests, quality-gate]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“Š ì „ì²´ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¢…í•©
        run: |
          echo "# ğŸ§ª AI ì˜ìƒ ê¸°íš ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ê° Job ê²°ê³¼ ìš”ì•½
          echo "## ğŸ“ˆ Jobë³„ ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "| Job | ìƒíƒœ | ì†Œìš”ì‹œê°„ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit & Integration | ${{ needs.unit-integration-tests.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance-tests.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | ${{ needs.quality-gate.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ì „ì²´ ê²°ê³¼ íŒì •
          OVERALL_SUCCESS="true"
          
          if [[ "${{ needs.quality-gate.result }}" == "failure" ]]; then
            OVERALL_SUCCESS="false"
            echo "## âŒ ì „ì²´ ê²°ê³¼: ì‹¤íŒ¨ (DoD í’ˆì§ˆ ê²Œì´íŠ¸ ë¯¸ë‹¬)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.unit-integration-tests.result }}" == "failure" || "${{ needs.e2e-tests.result }}" == "failure" ]]; then
            OVERALL_SUCCESS="false"
            echo "## âŒ ì „ì²´ ê²°ê³¼: ì‹¤íŒ¨ (ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨)" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… ì „ì²´ ê²°ê³¼: ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "OVERALL_SUCCESS=$OVERALL_SUCCESS" >> $GITHUB_ENV
          
          # ë‹¤ìŒ ë‹¨ê³„ ê¶Œì¥ì‚¬í•­
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸš€ ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
          if [[ "$OVERALL_SUCCESS" == "true" ]]; then
            echo "- âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ - ë°°í¬ ê°€ëŠ¥ ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š ì„±ëŠ¥ ë©”íŠ¸ë¦­ ëª¨ë‹ˆí„°ë§ ê³„ì†" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”„ ì •ê¸° í’ˆì§ˆ ê²€í†  ì˜ˆì •" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ìˆ˜ì • í•„ìš”" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” DoD ê¸°ì¤€ ì¬ê²€í† " >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ› ï¸ ì½”ë“œ í’ˆì§ˆ ê°œì„ " >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ’¬ PR ëŒ“ê¸€ (Pull Requestì¸ ê²½ìš°)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { OVERALL_SUCCESS } = process.env;
            const icon = OVERALL_SUCCESS === 'true' ? 'âœ…' : 'âŒ';
            const status = OVERALL_SUCCESS === 'true' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';
            
            const comment = \`
            ## ${icon} AI ì˜ìƒ ê¸°íš ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${status}
            
            **í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì •ë³´:**
            - ğŸ”§ íŠ¸ë¦¬ê±°: ${context.eventName}
            - ğŸ·ï¸ ë¸Œëœì¹˜: ${context.ref}
            - ğŸ• ì‹¤í–‰ì‹œê°„: ${new Date().toLocaleString('ko-KR')}
            
            **ìƒì„¸ ê²°ê³¼ëŠ” [Actions íƒ­](${context.payload.pull_request.html_url.replace('/pull/', '/actions/runs/')})ì—ì„œ í™•ì¸í•˜ì„¸ìš”.**
            
            ${OVERALL_SUCCESS === 'false' ? 'âš ï¸ **ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ë‹¤ì‹œ ì»¤ë°‹í•´ì£¼ì„¸ìš”.**' : 'ğŸ‰ **ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!**'}
            \`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: ğŸ¯ ìµœì¢… ê²°ê³¼ ì„¤ì •
        run: |
          if [[ "${{ env.OVERALL_SUCCESS }}" != "true" ]]; then
            echo "::error::AI ì˜ìƒ ê¸°íš ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            exit 1
          else
            echo "::notice::AI ì˜ìƒ ê¸°íš ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì„±ê³µ"
          fi