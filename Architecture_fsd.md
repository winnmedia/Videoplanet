# ARCHITECTURE_FSD.md — VideoPlanet 개발수칙(핵심 요약)

> 본 문서는 **Feature-Sliced Design(FSD) + Clean Architecture**의 핵심 규칙만을 다룹니다.  
> 운영·프로세스·테스트·보안 등 일반 규범은 `DEVELOPMENT_RULES.md`를 따릅니다.

---

## 1) 목적
- **예측 가능한 변경**과 **팀 병렬 작업**을 보장하고, **의존 경계**와 **공개 인터페이스**를 통해 파급을 최소화합니다.

---

## 2) TL;DR
- **레이어(상→하만 의존)**: `app → processes → pages → widgets → features → entities → shared`
- **Public API만 import**: 슬라이스 외부 노출은 `index.ts`(배럴)로 한정
- **Atomic UI는 공용으로만**: 도메인 지식이 없는 재사용 UI에 한정
- **린트로 강제**: 상향 의존·내부 파일 직접 import 금지(필수)

---

## 3) 배치 기준(결정 트리)
- **도메인 데이터/규칙/정규화** → `entities/<domain>`
- **사용자 행동(버튼·폼·필터) UI/로직** → `features/<feature>`
- **여러 화면에서 쓰는 큰 블록** → `widgets/<block>`
- **복합 사용자 여정(온보딩·결제 등)** → `processes/<flow>`
- **완전 범용(UI·유틸·타입·토큰·API 베이스)** → `shared/*`

> 애매하면: “도메인 규칙인가?” → `entities` / “행동 UI/로직인가?” → `features`

---

## 4) 의존·임포트 규칙
- **허용 방향**: 상위 레이어 → 하위 레이어만
- **금지**: 하위→상위 import, 동일 레벨 간 임의 참조, 내부 파일 직접 import
- **원칙**: 외부 사용은 항상 **배럴(Public API)** 경유

---

## 5) 데이터·상태 원칙
- **서버 캐시/패칭**: RTK Query(또는 동급) 권장
- **전역 도메인 상태**: `entities`에 배치(정규화·셀렉터 포함)
- **일시적/폼 상태**: `features`에 한정
- **WebSocket**: 수신→정규화는 `entities`에서 수행
- **DTO→도메인 변환**: `entities`의 전용 변환 레이어에서 일원화

---

## 6) Next.js(App Router) 일반 규칙
- **RSC 기본**, 필요한 곳에만 `"use client"`
- **서버 전용 모듈 가드** 사용, 라우트 핸들러는 캐시 정책 명시
- **환경변수 노출 통제**: 클라이언트는 `NEXT_PUBLIC_*`만

---

## 7) 금지/권장 패턴
**금지**
- 내부 파일 직접 import(배럴 우회)
- `shared`에 도메인 지식/상태 유입
- `features`에 장기 도메인 상태 상주
- 깊은 상대경로, 무단 별칭 추가

**권장**
- 컴포넌트·훅의 **계약면(Props/반환값)** 최소화
- 런타임 스키마 검증 후 도메인 변환
- 디자인 토큰·공용 컴포넌트 일원화

---

## 8) 테스트 원칙
- **단위**: 도메인 규칙·정규화·리듀서/셀렉터(entities 중심)
- **컴포넌트**: 행동 UI 상호작용·접근성(features/ui)
- **통합(E2E)**: 핵심 사용자 여정(스모크)
- **규칙**: 결정론적·배럴 import 사용·스냅샷 남용 금지

---

## 9) 린트·정적 분석
- **경계 강제**: 상향 의존·내부 파일 직접 import 금지 룰 필수
- **써큘러 0**: 순환 의존 검출을 CI에서 상시 체크
- **타입·스타일 규칙**: PR 게이트에서 강제

---

## 10) 마이그레이션(요약)
- **새 코드부터 100% FSD**(스트랭글러 패턴)
- **공용 자산**은 `shared`로, **핵심 도메인**은 `entities`로 우선 이전
- **경고→에러** 단계로 린트 강도를 점진 상향
- **배럴 인터페이스 유지**로 롤백시 파급 최소화

---

## 11) PR 체크리스트(FSD 전용)
- [ ] 레이어 규칙 준수(상향 의존/동일 레벨 임의 참조 없음)
- [ ] 내부 파일 직접 import 없음(배럴만 사용)
- [ ] 도메인 상태/규칙은 `entities`, 일시/폼은 `features`
- [ ] DTO→도메인 변환은 전용 레이어에서 일관 처리
- [ ] 데이터 접근 위치 일관(패칭·정규화·캐시 정책)
- [ ] 테스트가 배럴 import 기반·결정론적
- [ ] 관련 문서(ADR/README) 갱신

---

## 12) 문서·책임
- **Code Owner**를 지정하여 본 문서의 단일 소스 유지
- 구조/규칙 변경은 **ADR 필수** → 리뷰 → 반영
- `DEVELOPMENT_RULES.md`에는 **본 문서 링크(TL;DR)**만 유지

---

**버전**: 1.0.0  
**최종 업데이트**: 2025-08-18  
**문서 소유자(Code Owner)**: (지정 필요)
